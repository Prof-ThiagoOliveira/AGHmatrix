\documentclass[letterpaper,12pt,oneside]{article}
\usepackage{hyperref}
%\pagestyle{headings}
\pagenumbering{arabic}

\setlength{\hoffset}{-1.5cm}
\setlength{\voffset}{-2cm}
\setlength{\textheight}{22.5cm}
\setlength{\textwidth}{17cm}
\renewcommand{\baselinestretch}{1.3}


%\VignetteIndexEntry{OneMap Tutorial}

<<include=FALSE>>=
library(knitr)

opts_chunk$set(fig.path='figure/minimal-', fig.align='center', fig.show='hold')
options(formatR.arrow=TRUE,width=90)
@


\begin{document}

\begin{titlepage}
  {\LARGE {\bf AGHmatrix Tutorial}}
  \medskip\hrule height 2pt
  \vspace{.08in}

  {\flushright Software for constructing relationship matrices using pedigree and molecular data for diploid and autotreploid species}
  
  \vspace{.4in}
  
  \begin{center}
    Rodrigo R Amadeu\textsuperscript{1*}, Catherine Cellon\textsuperscript{2}, James W. Olmstead\textsuperscript{2}, A Augusto F Garcia\textsuperscript{1}, Marcio F. Resende\textsuperscript{2} and Patricio R Munoz\textsuperscript{3}
  \end{center}
  
   
  \vspace{.8in}

    Department of Genetics\textsuperscript{1}\\
    ``Luiz de Queiroz'' College of Agriculture (ESALQ)\\
    University of Sao Paulo (USP) - Brazil\\

  \vspace{.1in}
  
    Department of Horticultural Sciences\textsuperscript{2} and Department of Agronomy\textsuperscript{3}\\
    Institute of Food and Agricultural Sciences (IFAS)\\
    University of Florida (UF) - USA\\
      

\vspace{0.5cm}
\noindent \textsuperscript{*}corresponding author\\
    E-mail: rodrigo.amadeu@usp.br\\
  \vspace{.16in}
  \begin{center}
\today
  \end{center}
 \end{titlepage}

\tableofcontents

\newpage

\section{Overview}
\label{overview}
AGH software is an R-package under development mainly to build relationship matrices using pedigree (A matrix) and/or Molecular markers (G matrix) with the possibility to build a combined matrix of Pedigree corrected by Molecular (H matrix). The package also works with Diploid and Autotetraploid Data.

For the pedigree diploid data, it uses the method proposed by Handerson (1976) and described in Mrode (2005).

For the pedigree autotetraploid data, it uses the method proposed by Kerr (2012) and described in Slater (2013).

For the molecular diploid data, it can use 2 methods: Powell(2010) and Van Raden (2008).

For the molecular autotetraploid data, it uses a variation of diploid methods which are under development.

The combined matrix H is under development.

\subsection{Citation}
How to cite this software:\\

\section{About R}
R is a free programming language widely used in statistical computing. To download R, please visit the Comprehensive R Archive Network (\url{http://cran.r-project.org}). At this website can be found many tutorials about how to start and use R. For I quick start, we recommended to follow the ``Introduction to R`` section in ``OneMap Tutorial`` available at (\url{http://cran.r-project.org/web/packages/onemap/index.html}) and/or the ``Verzani's simpleR --- Using R for Introductory Statistics`` available at (\url{http://cran.r-project.org/doc/contrib/Verzani-SimpleR.pdf}).

\section{Installing the Package}

First, go to (\url{https://github.com/rramadeu/AGH-matrix}) and download the file ``AGHmatrix\underline{ }0.15.tar.gz``. There are several ways to install a package in R, here we list 3 ways.\\

\subsection{Installing using terminal (Linux and Mac)}
Open your terminal, go to the same folder ``AGHmatrix\underline{ }0.15.tar.gz`` is located (using the command \texttt{cd}) and type:\\
\texttt{R CMD INSTALL AGHmatrix\underline{ }0.15.tar.gz}\\
Some machines renames the name of the file when you download it removing the "gz" sufix, you can check it using the terminal command "ls". If it is the case, you can install the package typing:\\
\texttt{R CMD INSTALL AGHmatrix\underline{ }0.15.tar}\\

\subsection{Installing using RStudio (Windows, Linux, and Mac)}
Open RStudio, go to \texttt{Tools}, and then, go to \texttt{Install Packages...}. Select \texttt{Install From Package: Archive File (.zip; .tar.gz)} and select the path of the downloaded file ``AGHmatrix\underline{ }0.15.tar.gz``. After, click to install. In the image below it is showed the paths.

\begin{figure}[ht!]
  \centering
  \includegraphics[width=.7\textwidth]{figures/rstudio.png}
  \caption{How to install AGHmatrix in RStudio.}
   \label{rconsole}
\end{figure}

\subsection{Installing using R}
To do it, decompress the package in a folder and, in R, install the development package in R "devtools":
<<>>=
install.packages("devtools")
@
Load the package:
<<>>=
library(devtools)
@
Set you directory to the same folder as the AGHmatrix.0.15.tar.gz is, for example:
<<>>=
setwd("/home/users/AGHmatrix")
@
Finally, for install:
<<>>=
install()
@

\subsection{After install}
\\After, open R (or RStudio) and type:
<<>>=
library(AGHmatrix)
@
The package should be available in your R package list.

\section{Loading your pedigree file}
After load the package you have to load your data file. For it, you can use the function \texttt{read.data()} or \texttt{read.csv()} for example.\\
Your data should be available in R as a dataframe where column 1 (or list 1) should be the individual name, column 2 (or list 2) should be parent 2, and column 3 (or list 3) should be parent 3. In the package there is a data example. To look it, type:
<<>>=
data(ped.mrode)
ped.mrode
@

The example above \texttt{ped.mrode} has 3 columns, where column 1 is the individual name, column 2 is the parental 1 name, column 3 is the parental 2 name.

\section{Relationship Matrix with Pedigree Data}
In this section is presented how to load the data and how to construct the relationship matrix for diploid and autotetraploid species. The pedigree-base relationship matrix calculation, matrix A, is performed according with a recursive method as presented in Mrode (2005) and described by Henderson (1976) and expanded for n-ploidy by Kerr (2012) described in Slater (2013).\\
In the algorithm, first occurs the preprocessing of the data. To the preprocessing of the pedigree, first, the individuals are numerated 1 to , where  is the total individuals of the pedigree data. Then, it is verified if they are chronological sorted (i.e., if the parents of a given individual n are located before it in the list). If not, the algorithm performs necessary permutes. After preprocessing, occurs the  matrix computation as presented in Mrode (2005) for diploid and Slater (2013) for autotetraploidy.
\subsection{Building A matrix}
To build the A matrix you need to type the function with the data, ploidy, double reduction and unknown values. For example, if ploidy equals to 2 and unknown value equals 0 is calculated as presented in Mrode (2005) with the following code:\\
<<>>=
Amatrix(data=ped.mrode,ploidy=2,unk=0)
@
\\
If ploidy equals to 4 and double reduction equals to 10\% is calculated as presented in Slater (2013) with the following code:\\
<<>>=
Amatrix(data=ped.mrode,ploidy=4,w=0.1,unk=0)
@
\\
More information about the Amatrix function you can have typing:
<<>>=
?Amatrix
@
\\

\section{Relationship Matrices with Molecular Data - G Matrix}

\section{Relationship Matrices with Pedigree and Molecular Data - H Matrix}

\section{Exporting your data as ASREML csv format}
In this section, we present how to use the function formatmatrix in order to export a matrix to a compatible ASREML format (csv file with 3 columns). In order to do it, we need to build a matrix, its inverse, and export it. Below we build an example of how to do it:\\
<<>>=
#setting the number of digits to display in R for 12
options(digits=12)
#loading the data example
data(ped.mrode)
#building the matrix
A<-Amatrix(data=ped.mrode, ploidy=4, w=0.1, unk=0)
#build the inverse
Ainv<-solve(A)
#exporting it
formatmatrix(Ainv, round.by=12, exclude.0=TRUE, name="Ainv0.1")
@
This script will create the following csv file:\\

\begin{figure}[ht!]
  \centering
  \includegraphics[width=.1\textwidth]{figures/csvfile.png}
  \caption{csv file representing an A matrix from ped.mrode data with w=0.1. The first 2 columns represent rows and columns of the matrix, the third column represents the value. All the rows with value equal to 0 it was excluded from the file.}
   \label{rconsole}
\end{figure}

\section{Making a \textit{loop} in order to get several matrices}
In this section, we present a simple "for" function for the user be able to get in a pratical way several matrices for different double reduction values to later be used in ASREML (for example). In R:\\
<<>>=
#setting the number of digits to display in R for 12
options(digits=12)
#loading the data example
data(ped.mrode)
#determining your double reduction range
double.red<-seq(0,0.2,0.05)
#extracting the length of double.red
n<-length(double.red)
#Looping it
for(i in 1:n){
    A<-Amatrix(data=ped.mrode,
               ploidy=4,
               w=double.red[i],
               unk=0)
    #making the inverse
    A.inv<-solve(A)
    #exporting as csv
    formatmatrix(data=A.inv,
                  name=paste("Ainv_",double.red[i],sep=""),
                  round.by=12,
                  exclude.0=TRUE)
}
@
At the end, it will get 5 files represents 5 matrices (w=0,0.05,0.1,0.15,0.2).

 
\section{References}
\setlength{\parindent}{0cm}

\parshape2 0pt \linewidth 0.8cm 16.2cm
Henderson, C. R. (1976). Simple method for computing the inverse of a numerator relationship matrix used in prediction of breeding values. Biometrics.

\parshape2 0pt \linewidth 0.8cm 16.2cm
Kerr, R. J. (2012). Use of numerator relationship matrix in genetic analysis of autopolyploid species. Theoretical and Applied Genetics, 124(7), 1271-1282.

\parshape2 0pt \linewidth 0.8cm 16.2cm
Mrode, R. A. (2005). Linear Models for the prediction of animal breeding values. Cabi.

\parshape2 0pt \linewidth 0.8cm 16.2cm
Powell, J. E. (2010). Reconciling the analysis of IBD and IBS in complex trait studies. Nature Reviews Genetics, 11(11), 800-805 (Suplementary Information).

\parshape2 0pt \linewidth 0.8cm 16.2cm
Slater, A. T. (2013). Improving the analysis of low heritability complex traits for enhanced genetic gain in potato. Theoretical and Applied Genetics, 1-12.

\parshape2 0pt \linewidth 0.8cm 16.2cm
Van Raden, P. M. (2008). Efficient methods to compute genomic predictions. Journal of Dairy Science, 91(11), 4414-4423.

\end{document}

